---
title: "plant complexity"
author: "C. Nell"
date: "7/27/2018"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
---

```{r, include=FALSE}
knitr::opts_chunk$set(tidy=TRUE,error = TRUE, eval = TRUE, message = FALSE, warning = FALSE,cache=TRUE, rows.print=5, cols.min.print=4)
theme_set(theme_minimal())

```

```{r Load preliminary packages, include=FALSE}
library(dplyr) ## for data wrangling - %>% function
library(reshape2) ##melt and cast data
library(tidyr) # 'separate' function
library(vegan) # dissimilarity matrix, permanova functions
library(tidyverse)
library(magrittr)
# phylogenies
library(phytools)
library(ape)
library(geiger)

se <- function(x) sqrt(var(x,na.rm=TRUE)/length(na.omit(x)))
```  
#### Data  
```{r}
oplant<-read.csv('data/2018/CSS_plant_data.csv')

# complexity data
plants<-read.csv('data/2018/CSS_comps.csv')%>%
  group_by(species)%>%
  dplyr::summarize(complex=mean(complexity/(3*diameter)), complex_se=se(complexity/(3*diameter)))
plants
```  

#### Plant phylogeny  
```{r, eval=FALSE, include=FALSE}
## S.PhyloMaker function to generate phylogeny for seed plants
source("https://raw.githubusercontent.com/jinyizju/S.PhyloMaker/master/R_codes%20for%20S.PhyloMaker")
# Citation: Qian, H. and Y. Jin. (2016) An updated megaphylogeny of plants, a tool for generating plant phylogenies and an analysis of phylogenetic community structure. Journal of Plant Ecology 9(2): 233â€“239.
# uses PhytoPhylo species-level megaphylogeny as a backbone (Zanne et al 2014)

phylo<-read.tree("data/trees/QianJin_2016.txt") # megaphylogeny from Qian & Jim 2016 "PhytoPhylo"
nodes<-read.table('https://raw.githubusercontent.com/jinyizju/S.PhyloMaker/master/nodes', fill=TRUE, header=TRUE)# nodes for phylogeny

sp.list<-read.csv('data/2018/css_taxa.csv')%>%
  dplyr::select(species, genus, family)

# artemisia species are not in megaphy, use representative taxa from subgenera for divergence
new.sp.list<-sp.list%>%
  mutate(species=ifelse(species == 'Artemisia californica', 'Artemisia tridentata', 
                        ifelse(species == 'Artemisia douglasiana', 'Artemisia ludoviciana', paste(species))))
result<-S.PhyloMaker(spList=new.sp.list, tree=phylo, nodes=nodes)# prune megaphy to species list
phy<-result$Scenario.1%>%makeLabel()

write.tree(phy, 'data/2018/css_phy_raw.tree')
```  

#### Intermediate predators : herbivores, IP:H  
```{r}
## read in phylogeny
phy<-read.tree('data/2018/css_phy_raw.tree')
```
```{r}
# ratio of predators to herbivores by plant species
ph.df<-oplant%>%group_by(species, treat)%>%summarize(mean=mean(pred_herb, na.rm=TRUE), se=se(pred_herb))
ph.df

ggplot(ph.df, aes(treat, mean))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+
  geom_point()+
  facet_wrap(~species)+
  labs(x='Treatment, C = control, T = bird exclusion', y='IP:H')

mod<-aov(pred_herb~treat, data=oplant)
summary(mod)

Anova(mod, type='III')
TukeyHSD(mod)
```
```{r}
## contrll vs exclusion treatment
ph.cast<-ph.df%>%dcast(species~treat, value.var='mean')
ph.cast

ggplot(ph.cast, aes(C, `T`))+
  geom_point(aes(color=species))+
  geom_smooth(method='lm', se=F, color='black')+
  geom_abline(slope=1, intercept=0, lty='dashed')+
  ylim(0,.3)+xlim(0,.3)+
  labs(y='Bird exclusion', x='Control')


lm.mod<-lm(`T`~C, data=ph.cast)
summary(lm.mod)
```  


